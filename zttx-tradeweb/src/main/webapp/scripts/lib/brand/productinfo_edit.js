function clickSetNum(){for(var len=$(".maintbody tr").length,data="[",i=0;len>i;i++){var price=$(".maintbody tr").eq(i).find("input[name=attr_combo_price]").val(),count=parseFloat($(".maintbody tr").eq(i).find("input[name=attr_combo_count]").val()),comboCc=$(".maintbody tr").eq(i).find("input[name=attr_combo_direct_price]").val(),comboCreditPrice=$(".maintbody tr").eq(i).find("input[name=attr_combo_credit_price]").val(),comboBc=$(".maintbody tr").eq(i).find("input[name=attr_combo_bar_code]").val(),priceIndex=$(".maintbody tr").eq(i).find("input[name=attr_combo_price]").data("index"),dataIndexArr=eval("("+priceIndex+")");data+='{"p":"'+price+'","s":'+count+',"dp":"'+comboCc+'","cp":"'+comboCreditPrice+'","bc":"'+comboBc+'","z":[',$.each(dataIndexArr,function(a,b){data+='{"a":"'+b.a+'","v":"'+b.v+'","vid":"'+b.vid+'"}',1>a&&(data+=",")}),data+="]}",len-1>i&&(data+=",")}data+="]",$("#init_value").length<=0?$("body").append('<div id="init_value" style="display: none;">'+data+"</div>"):$("#init_value").html(data),productmanage.parseValue()}function setAttrFormData(){$("#saleAttrFormData").html(""),$("#proAttrFormData").html(""),$("#proSaleAttr input[id^='attr_chk_']:checked").each(function(){var a=$("#saleAttrFormData div.data").size(),b="saleAttrs["+a+"]",c=$(this).attr("data-type"),d=$(this).attr("data-id"),e=$(this).parent().find("input.getext").val(),f=$("#colorImgUrls_"+d).val(),g=$("#colorImgNames_"+d).val();void 0==f&&(f="");var h="<div class='data' >";h+="<input type='text' name='"+b+".attributeNo' value='"+c+"' >",h+="<input type='text' name='"+b+".attributeValue' value='"+e+"' >",h+="<input type='text' name='"+b+".valueId' value='"+d+"' >",h+="<input type='text' name='"+b+".attributeIcon' value='"+f+"' >",h+="<input type='text' name='"+b+".domainName' value='"+g+"' >",h+="</div>",$("#saleAttrFormData").append(h)}),$("#proAttribute input.ui-checkbox:checked,#proAttribute select").each(function(){var a=$("#proAttrFormData div.data").size(),b="attributes["+a+"]",c=$(this).attr("data-attrno"),d=$(this).val(),e="<div class='data' >";e+="<input type='text' name='"+b+".attributeNo' value='"+c+"' >",e+="<input type='text' name='"+b+".attrValueId' value='"+d+"' >",e+="</div>",$("#proAttrFormData").append(e)}),$("#proAttribute input.ui-input").each(function(){var a=$("#proAttrFormData div.data").size(),b="attributes["+a+"]",c=$(this).attr("data-attrno"),d=$(this).val();if(""!=d){var e="<div class='data' >";e+="<input type='text' name='"+b+".attributeNo' value='"+c+"' >",e+="<input type='text' name='"+b+".attrValue' value='"+d+"' >",e+="</div>",$("#proAttrFormData").append(e)}})}function setProAttrPriceFormData(){$("#proAttrPriceFormData").html(""),$("#selectmix .maintbody tr").each(function(){var index=$("#proAttrPriceFormData div.data").size(),prefix="priceModels["+index+"]",$dataDom=$(this).find("input[name='attr_combo_price']"),data=eval("("+$dataDom.attr("data-index")+")"),price=$dataDom.val(),store=$(this).find("input[name='attr_combo_count']").val(),html="<div class='data' >";html+="<input type='text' name='"+prefix+".p' value='"+price+"' >",html+="<input type='text' name='"+prefix+".s' value='"+store+"' >";for(var i in data){var $colorImg=$("#colorImgUrls_"+data[i].vid),icon="";0!=$colorImg.size()&&(icon=$colorImg.val(),""==icon&&(icon=$("#attr_chk_"+data[i].a+"_"+data[i].vid).data("icon")));var value=$("#attredit_"+data[i].a+"_"+data[i].vid).val();html+="<input type='text' name='"+prefix+".z["+i+"].a' value='"+data[i].a+"' >",html+="<input type='text' name='"+prefix+".z["+i+"].v' value='"+value+"' >",html+="<input type='text' name='"+prefix+".z["+i+"].vid' value='"+data[i].vid+"' >",0!=$colorImg.size()&&(html+="<input type='text' name='"+prefix+".z["+i+"].icon' value='"+icon+"' >")}html+="</div>",$("#proAttrPriceFormData").append(html)})}function productCateValidated(a){var b=$("input[name='productCate']:checked").val();2==b?a.addItem({element:".presetname",required:!0,rule:"minlength{min:1}",errormessageRequired:"请输入预定名称"}).addItem({element:".shippingtime",required:!0,rule:"minlength{min:1}",errormessageRequired:"请选择出货时间"}).addItem({element:".ordertime",required:!0,rule:"minlength{min:1}",errormessageRequired:"请选择订货时间"}).addItem({element:".needeposit",required:!0,rule:"minlength{min:1}",errormessageRequired:"请选择是否需要订金"}).addItem({element:".orderamount",required:!0,rule:"minlength{min:1}",errormessageRequired:"请输入订货量"}):a.removeItem(".presetname").removeItem(".shippingtime").removeItem(".ordertime").removeItem(".needeposit").removeItem(".orderamount")}function beginTypeValidated(a){var b=$("input[name='beginType']:checked").val();2==b?a.addItem({element:"#datatimemm",required:!0,rule:"minlength{min:1}",errormessageRequired:"请输入开始时间"}):a.removeItem("#datatimemm")}productmanage.dataCache={};var cateTreeObj,brandTmpJson=[],tiggerSxFlag=!1,changeCreditFlag=function(){$("#supportCredit").prop("checked")?($(".js-tigger-sx").show(),$("#js-setcommon-type option[value=3]").show().prop("disabled",!1),tiggerSxFlag=!0):($(".js-tigger-sx").hide(),$("#js-setcommon-type option[value=3]").hide().prop("disabled",!0),tiggerSxFlag=!1)};changeCreditFlag();var addNew_changeBrandTmp=function(a){$.ajax({type:"POST",url:"/brand/product/brandTemplate",data:{brandsId:a},dataType:"json",cache:!1,success:function(a){var b="<option value=''></option>";for(var c in a){var d=a[c].refrenceId;brandTmpJson[d]=a[c],b+="<option value='"+d+"'>"+a[c].templateName+"</option>"}$("#ppchoice1").html(b),$("#ppchoice1").on("change",function(){var a=$(this).val(),b=brandTmpJson[a];$("#orderName").val(b.templateName),$("#startNum").val(b.startNum),$("#orderNum").val(b.orderNum),$("#orderMoney").val(b.orderMoney),$("input[name='orderSelect']")[b.orderSelect].checked=!0,1==b.orderSelect&&$("#order_amount").show();var c=new Date(b.outStart),d=new Date(b.outEnd),e=new Date(b.orderStart),f=new Date(b.orderEnd);$("#start-cal2").val(c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate()),$("#end-cal2").val(d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate()),$("#start-cal").val(e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate()),$("#end-cal").val(f.getFullYear()+"-"+(f.getMonth()+1)+"-"+f.getDate())})}})},addNew_loadAttr=function(){},addNew_setProCate=function(a,b){$.ajax({type:"POST",url:"/brand/product/catalogTree",data:{brandesId:b},dataType:"json",cache:!1,success:function(b){var c=b;seajs.use(["ztree"],function(b){var d={check:{enable:!0,chkboxType:{Y:"ps",N:"s"}},view:{showIcon:!1}};if(cateTreeObj=$.fn.zTree.init($("#catalog"),d,c),cateTreeObj.expandAll(!0),""!=a){var e=a.split(","),f=cateTreeObj.transformToArray(cateTreeObj.getNodes());for(var g in f){var h=f[g];for(var i in e)if(e[i]==h.id){cateTreeObj.checkNode(h,!0);break}}}})}})},addNew_setProLine=function(a,b){$.ajax({type:"POST",url:"/brand/product/lineTree",data:{brandesId:b,productId:a},dataType:"json",cache:!1,success:function(a){var b=new Array;for(var c in a){var d=a[c],e="<li><input type='checkbox' class='ui-checkbox' name='lineIdAry' value='"+d.refrenceId+"' id='"+d.refrenceId+"'";d.selected&&(e+=" checked='checked'"),e+=" /><a href='javascript:;'>"+d.lineName+"</a></li>",b[c]=e}$("#proLine_ul").html(b.join("")),$("#proLine_ul a").click(function(){$(this).parent().find("input").click()})}})},addNew_formSubmit=function(){var a=cateTreeObj.getCheckedNodes(),b=new Array,c=0;for(var d in a){var e=a[d];0==e.children.length&&(b[c]=e.id,c++)}$("#cateIds").val(b.join(","));var f=$("#proLine_ul input:checked"),g="";f.each(function(){""!=g&&(g+=","),g+=this.id}),$("#lineIds").val(g),$("#brandsName").val($("#ppchoice :selected").text()),setAttrFormData(),setProAttrPriceFormData()};productmanage.showCustomerTip=function(){var a=!0,b=[];$("#proSaleAttr ul").each(function(){a&=0!=$(this).find(":checked").size(),b.push({name:$(this).data("name"),chks:$(this).find(":checked")})});var c=[];if(a){$("div.notalltip").hide(),$("#selectmix").show(),$(".tablelong-auto").show();for(var d=0;d<b.length;d++)$("#selectmix thead tr th:eq("+d+")").html(b[d].name);var e="";if($(".coloreditul").length>1){b[0].chks.each(function(a,d){var f=$(this),g=a;b[1].chks.each(function(a){var b=$(this),d=a,h=(g.toString()+d.toString(),"{'a':'"+f.data("type")+"','v':'"+f.data("text")+"','vid':'"+f.data("id")+"'}"),i="{'a':'"+b.data("type")+"','v ':'"+b.data("text")+"','vid':'"+b.data("id")+"'}",j="["+h+","+i+"]",k=[];k.push(f.data("type")+"_"+f.data("id")),k.push(b.data("type")+"_"+b.data("id"));var l=productmanage.dataCache[k.join("-")];null==l&&(l=[0,0,0,"",0]),c.push('<tr style="display: table-row; *display:block;">'),e=f.data("text"),c.push('<td width="90"><span class="colorfont" name="attrcomb_'+f.data("type")+"_"+f.data("id")+'">'+f.data("text")+'</span><input type="hidden" name="attr_color_super_ids" value="'+f.data("type")+'"/><input type="hidden" name="attr_color_ids" value="'+f.data("id")+'" /><input type="hidden" name="attr_color_values" data-id="color_value_'+f.data("type")+"_"+f.data("id")+'" value="'+f.data("text")+'" /></td>'),c.push('<td width="90"><span class="colorfont" name="attrcomb_'+$(this).data("type")+"_"+$(this).data("id")+'">'+b.data("text")+'</span><input type="hidden" name="attr_size_super_ids" value="'+b.data("type")+'"/><input type="hidden" name="attr_size_ids" value="'+b.data("id")+'" /><input type="hidden" name="attr_size_values" data-id="size_value_'+b.data("type")+"_"+b.data("id")+'" value="'+b.data("text")+'" /></td>'),c.push('<td width="90"><input type="text" data-index="'+j+'" class="ui-input wantnumber js-price" name="attr_combo_price" style="width:65px;" value='+(null==l[0]?0:parseFloat(l[0]).toFixed(2))+"></td>"),c.push('<td width="90"><input type="text" data-index="'+j+'" class="ui-input js-price" name="attr_combo_direct_price" style="width:65px;" value='+(null==l[2]?0:parseFloat(l[2]).toFixed(2))+" ></td>"),c.push('<td width="90" class="js-tigger-sx" style="'+(0==tiggerSxFlag?"display: none;":"")+'"><input type="text" data-index="'+j+'" data-sx="'+f.data("text")+b.data("text")+'" class="ui-input js-price" name="attr_combo_credit_price" style="width:65px;" value='+(null==l[4]?0:parseFloat(l[4]).toFixed(2))+"></td>"),c.push('<td width="90"><input type="text" data-index="'+j+'" class="ui-input wantnumber js-price" data-max="100000000" style="width:65px;" name="attr_combo_count" value='+(null==l[1]?0:l[1])+"></td>"),c.push('<td width="190"><input type="text" data-index="'+j+'" class="ui-input" name="attr_combo_bar_code" style="width:160px;" value='+(null==l[3]?" ":l[3])+"></td>"),c.push("</tr>")})})}else 1==$(".coloreditul").length&&b[0].chks.each(function(a){var b=$(this),d="{'a':'"+b.data("type")+"','v':'"+b.data("text")+"','vid':'"+b.data("id")+"'}",e="["+d+"]",f=[];f.push(b.data("type")+"_"+b.data("id"));var g=productmanage.dataCache[f.join("-")];for(null==g&&(g=[0,0,0,"",0]),c.push('<tr style="display: table-row;*display:block;">'),c.push('<td width="90"><span class="colorfont" name="attrcomb_'+b.data("type")+"_"+b.data("id")+'">'+b.data("text")+'</span><input type="hidden" name="attr_color_super_ids" value="'+b.data("type")+'"/><input type="hidden" name="attr_color_ids" value="'+b.data("id")+'" /><input type="hidden" name="attr_color_values" data-id="color_value_'+b.data("type")+"_"+b.data("id")+'" value="'+b.data("text")+'" /></td>'),c.push('<td width="90"><input type="text" data-index="'+e+'" class="ui-input wantnumber js-price" name="attr_combo_price" value='+(null==g[0]?0:parseFloat(g[0]).toFixed(2))+"></td>"),c.push('<td width="90"><input type="text" data-index="'+e+'" class="ui-input js-price" name="attr_combo_direct_price" value='+(null==g[2]?0:parseFloat(g[2]).toFixed(2))+"></td>"),c.push('<td width="90" class="js-tigger-sx" style="'+(0==tiggerSxFlag?"display: none;":"")+'"><input type="text" data-index="'+e+'" class="ui-input js-price" name="attr_combo_credit_price" data-sx="'+b.data("text")+'" value='+(null==g[4]?0:parseFloat(g[4]).toFixed(2))+" ></td>"),c.push('<td width="90"><input type="text" data-index="'+e+'" class="ui-input wantnumber js-price" data-max="100000000" name="attr_combo_count" value='+(null==g[1]?0:g[1])+"></td>"),c.push('<td width="190"><input type="text" data-index="'+e+'" class="ui-input" name="attr_combo_bar_code" style="width:160px;" value='+(null==g[3]?" ":g[3])+"></td>"),c.push("</tr>"),a=0;5>a;a+=2)/\./.test(g[a])||(g[a]+=".00")});$("#selectmix tbody").empty().append(c.join("")),$("#selectmix tbody input.js-price").isPrice(),$("#selectmix tbody input.js-number").isPrice(!1)}else 1==$(".coloreditul").length?$("div.notalltip").hide():$("div.notalltip").show(),$("#selectmix").hide(),$("#selectmix tbody").empty(),$(".tablelong-auto").hide()},productmanage.showColorConfig=function(){var a=!1,b=[];$("#proSaleAttr ul").each(function(){$(this).data("color")&&$(this).find(":checked").each(function(c){a=!0;var d=$(this).data("id"),e=$(this).data("type"),f=$("#colorImgUrls_"+d),g="",h=$(this).data("domain");0!=f.size()&&(g=f.val()),""==g&&(g=$(this).data("icon")),b.push('<tr class="colorshow" style="display: table-row;*display:block;">'),b.push('<td class="td-first-Bor">'),g.toString().length<=6?b.push('    <div id="ico_fileUp_'+d+'" style="background:#'+g+';margin-left: 5px;" class="colorpickbox inline-block"></div>'):b.push('    <div id="ico_fileUp_'+d+'" style="background-image:url('+window.IMAGE_DOMIAN+g+');background-repeat:no-repeat;background-size:16px 16px;margin-left: 5px;" class="colorpickbox inline-block"></div>'),b.push('    <span class="colorfont" id="attrtext_'+e+"_"+d+'">'+$(this).data("text")+"</span>"),b.push('<input type="hidden" id="colorImage_ids_'+e+"_"+d+'" name="attr_colorImage_ids" value="'+d+'" />'),b.push('<input type="hidden" id="colorImage_urls_'+e+"_"+d+'" name="attr_colorImage_urls" value="'+g+'" />'),b.push(" </td>"),b.push("<td>"),b.push('    <div class="file_wrap inline-block">'),b.push('          <p class="simple_button">文件上传</p>'),b.push('         <input type="file" value="文件上传" name="photo" id="fileUp_'+d+'" onchange="colorImgUpload(this);" class="input_file" data-type='+e+" data-id="+d+">"),b.push('     <div class="data" style="display: none;" id="div_fileUp_'+d+'"><input type="hidden" id="colorImgUrls_'+d+'" name="colorImgUrls" value='+g+' /><input type="hidden" id="colorImgNames_'+d+'" name="colorImgNames" value="'+h+'" /></div>'),b.push("     </div>"),b.push('     <a class="simple_button js-selectgroup-pic" onclick="setPosition(this);">图库选择</a>'),b.push('     <a href="javascript:;" onclick="delColorImage(this);" class="orangefont">移除图片</a>'),b.push(" </td>"),b.push("</tr>")})}),a?($("#selectchicun tbody").empty().append(b.join("")),$("#selectchicun").show()):$("#selectchicun").hide(),addNew.selectgroup()},productmanage.checkAllAttr=function(){var a=$(this).attr("id").split("_")[1],b=$(this).prop("checked");$("#attrul_"+a+" :checkbox").not(":disabled").each(function(){$(this).prop("checked",b),1==$(this).prop("checked")&&($(this).parent().find(".colorfont").hide(),$(this).parent().find(".getext").css("display","inline-block")),0==$(this).prop("checked")&&($(this).parent().find(".colorfont").show(),$(this).parent().find(".getext").hide())}),productmanage.showCustomerTip(),productmanage.showColorConfig()},productmanage.editAttrCombo=function($this){var cache_key=[],val1=$this.parent().parent().find("input[name=attr_combo_price]").val(),val2=$this.parent().parent().find("input[name=attr_combo_count]").val(),val3=$this.parent().parent().find("input[name=attr_combo_direct_price]").val(),val4=$this.parent().parent().find("input[name=attr_combo_bar_code]").val(),val5=$this.parent().parent().find("input[name=attr_combo_credit_price]").val(),dataIndexArr=eval("("+$this.data("index")+")");$.each(dataIndexArr,function(a,b){cache_key.push(b.a+"_"+b.vid)}),productmanage.dataCache[cache_key.join("-")]=[val1,val2,val3,val4,val5]},productmanage.attrEdit=function(){var a=$(this).attr("id").split("_");$("#attrtext_"+a[1]+"_"+a[2]).html($(this).val()),$("#attrshow_"+a[1]+"_"+a[2]).html($(this).val()),$("span[name=attrcomb_"+a[1]+"_"+a[2]+"]").html($(this).val()),$("#attr_chk_"+a[1]+"_"+a[2]).data("text",$(this).val()),$("input[data-id=color_value_"+a[1]+"_"+a[2]+"]").val($(this).val()),$("input[data-id=size_value_"+a[1]+"_"+a[2]+"]").val($(this).val())},productmanage.parseValue=function(){if(0!=$("#init_value").size()){for(var obj=eval("("+$("#init_value").text()+")"),i=0;i<obj.length;i++){for(var key=[],j=0;j<obj[i].z.length;j++)key.push(obj[i].z[j].a+"_"+obj[i].z[j].vid);productmanage.dataCache[key.join("-")]=[obj[i].p,obj[i].s,obj[i].dp,obj[i].bc,obj[i].cp]}productmanage.showCustomerTip(),productmanage.showColorConfig()}},productmanage.batchSetting=function(){$("input[name=dprice_n]").click(function(){var a=$(".js-revise-zprice");if(1==$(".js-revise-zjradio").prop("checked"))a.attr("maxlength",8).removeClass("setcommon-error");else{var b=a.val();a.attr("maxlength",4),(0>=b||b>10)&&a.addClass("setcommon-error")}}),$(".js-revise-zprice").change(function(){var a=$(this).val();1==$(".js-revise-zkradio").prop("checked")&&(0>=a||a>10)?($(this).addClass("setcommon-error"),remind("error","折扣必须大于0小于10")):$(this).removeClass("setcommon-error")}),$(document).on("click",".js-revise-set",function(){var a=""==$(".js-revise-dprice").val()?0:parseFloat($(".js-revise-dprice").val()),b=""==$(".js-revise-zprice").val()?0:parseFloat($(".js-revise-zprice").val()),c=""==$(".js-revise-cprice").val()?0:parseFloat($(".js-revise-cprice").val()),d=$(".js-revise-dcount").val(),e=1==$(".js-revise-zjradio").prop("checked")?0:1;0!=a&&$("input[name^=attr_combo_price]").val(a.toFixed(2)),$("#selectmix .maintbody tr").each(function(){if(0==e)""!=b&&$("input[name=attr_combo_direct_price]").val(b.toFixed(2));else if(1==e&&""!=b)if(0!=b&&10>=b)if(0!=a)$(this).find("input[name=attr_combo_direct_price]").val((a*b/10).toFixed(2));else{var c=""==$(this).find("input[name=attr_combo_price]").val()?0:$(this).find("input[name=attr_combo_price]").val();$(this).find("input[name=attr_combo_direct_price]").val((c*b/10).toFixed(2))}else remind("error","折扣必须大于0小于10")}),""!=d&&$("input[name=attr_combo_count]").val(d),0!=c&&$("input[name=attr_combo_credit_price]").val(c.toFixed(2)),clickSetNum(),$(".js-revise-dprice").val(""),$(".js-revise-zprice").val(""),$(".js-revise-dcount").val(""),$(".js-revise-cprice").val("")})},productmanage.realModifyPrice=function(){function a(){var a=$("input[name=costPush]");for(var c in b)if(void 0!=b[c].np&&b[c].op<b[c].np)return a.eq(0).prop({checked:!1,disabled:!0}),a.eq(1).prop("checked",!0),!1;a.eq(0).prop({disabled:!1})}var b={};$("#selectmix input[name=attr_combo_credit_price]").each(function(){var a=$(this).data("sx");b["sx_"+a]={},b["sx_"+a].op=$(this).val()}),$("#selectmix").on("blur","input[name=attr_combo_credit_price]",function(){var c=$(this).data("sx");b["sx_"+c]&&(b["sx_"+c].np=$(this).val(),a())})},$(function(){$("input[id^='attrCheckedAll']").click(productmanage.checkAllAttr),$("input[id^='attredit']").change(productmanage.attrEdit),$("#selectmix").on("change","input[name^='attr_combo']:not(input[name=attr_combo_count],input[name=attr_combo_bar_code])",function(){productmanage.editAttrCombo($(this));var a=$(this).val();a>0?$(this).removeClass("input-error"):$(this).addClass("input-error"),$(this).val(parseFloat(a).toFixed(2))}),$("#samplePrice").blur(function(){var a=$(this).val();""!=a&&(a>0?$(this).removeClass("input-error"):$(this).addClass("input-error"),$(this).val(parseFloat(a).toFixed(2)))}),productmanage.batchSetting(),setTimeout(function(){productmanage.parseValue(),productmanage.realModifyPrice()},500),$(".productadd").on("click",".colorchk",function(){1==$(this).prop("checked")&&($(this).parent().find(".colorfont").hide(),$(this).parent().find(".getext").css("display","inline-block")),0==$(this).prop("checked")&&($(this).parent().find(".colorfont").show(),$(this).parent().find(".getext").hide()),productmanage.showCustomerTip(),productmanage.showColorConfig($(this))}),$(".productadd").on("click","#supportCredit",function(){changeCreditFlag()})}),$("#productGroom").change(function(){var a=this.checked;if(a){var b=$("#groomTotal").data("groom"),c=$("#groomUsed").data("groom");c>=b?$("#groomCheck").val(""):$("#groomCheck").val("normal")}else $("#groomCheck").val("normal")});