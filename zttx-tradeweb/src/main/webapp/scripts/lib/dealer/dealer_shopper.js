var myShopper_index={init:function(){this.initCheckbox(),this.initEntryNumber(),this.initFavorite(),this.initDelete(),this.SmellSOA(),this.SettlementOfAccounts(),this.initQuickOrder(),this.initClearCart(),this.initSubmit(),this.initTable(),this.initAccordion(),seajs.use(["sticky"],function(a){a("#settle_accounts")})},initCheckbox:function(){var a=this;checkAll("#CheckAll",".brand-list .ui-checkbox",function(){a.SettlementOfAccounts()}),$("#DeleteAll").click(function(){var a=[];return $(".s-chk:checked").each(function(b,c){a.push($(c).attr("pid"))}),a.length<1?(remind("error","至少勾选一个产品"),!1):void confirmDialog({title:"提示",content:"确定移除吗"},function(){$.post(G_PATH+"/dealer/shoper/deleteAll",{ids:a.join(",")},function(a){null!=a&&(111e3==a.code?(remind("success","成功移除"),window.location.reload()):remind("error",a.message))},"json")})}),$(".b-chk").change(function(){var b=this;$(this).parent().next().find(".s-chk").each(function(a,c){c.checked=b.checked}),a.SettlementOfAccounts()})},initEntryNumber:function(){var a=this;$(".item-amount").cartInit({priceTag:".price",totalTag:".total",maxerror:"超过库存值!"},function(){$(".js-clearing").data({issubmit:!1})},function(b,c){a._updateSingle(c),a.SettlementOfAccounts()})},initFavorite:function(){$(".addColl").click(function(){var a=$(this).attr("pid");$.post(G_PATH+"/dealer/favorite/save",{productId:a},function(a){a=$.parseJSON(a),null!=a&&(126e3==a.code?remind("success","产品收藏成功"):remind("error",a.message))})})},initDelete:function(){$(".delOne").click(function(){var a=$(this).attr("pid");confirmDialog({title:"提示",content:"确定移除吗"},function(){$.post(G_PATH+"/dealer/shoper/delete",{id:a},function(a){null!=a&&(111e3==a.code?(remind("success","移除成功"),window.location.reload()):remind("error",a.message))},"json")})})},initSubmit:function(){$(".js-clearing").on("click",function(a){var b=$(".js-clearing").data("issubmit");if(!b)return!1;var c=!0;if($(".s-chk:checked").length<1)return remind("error","至少勾选一个产品"),void(c=!1);$("._hidDiv").each(function(){$(this).parent().find(".s-chk").prop("checked")?$(this).removeAttr("disabled"):$(this).attr("disabled",!1)});var d=[];$(".s-chk:checked").each(function(){d.push($(this).attr("pid"))});var e="";if($(".stNumClass").each(function(){if($(this).next().prop("checked")){var a=$(this).val(),b=0,c=$(this).parents(".goods-item").find(".pNoClass").html();$(this).parents(".goods-item").find(".txt-buyNum").each(function(){b+=parseInt($(this).val())}),null!=a&&a>b&&(e+=c,e+=",")}}),""!=e){var f=e.lastIndexOf(",");e=e.substring(0,f);var g=e.split(","),h=g.length,i="产品 "+e+" 没有达到起批量的要求，请检查后再次进行结算";return h>2&&(e=g[0]+","+g[1],i=e+" 等商品没有达到起批量的要求，请检查后再次进行结算"),confirmDialog({title:"提示",content:i},function(){},!1,function(){},!0),void(c=!1)}c&&($("#_productIds").val(d.join(",")),$("#myForm").submit())})},SmellSOA:function(){$(".item-amount").each(function(a,b){var c=$(b).parent().parent().find(".price").text(),d=(Number(c)*$(b).find(".txt-amount").val()).toFixed(2);$(b).parent().parent().find(".total").text(d)})},SettlementOfAccounts:function(){var a=0,b=0;$(".goods-main-count").each(function(b,c){for(var d=$(c).prev().find(".txt-amount"),e=0,b=0;b<d.length;b++)e+=Number(d[b].value);$(c).find(".buycountXj").text(e),$(c).parent().find("input:checked").size()>0&&(a+=Number($(c).find(".buycountXj").text()))}),$(".goods-main-amount").each(function(a,c){for(var d=$(c).prev().prev().find(".total"),e=0,a=0;a<d.length;a++)e+=Number(d[a].innerHTML);$(c).text(e.toFixed(2)),$(c).parent().find("input:checked").length>0&&(b+=Number($(c).text()))});$("#AllCount").text(a),$("#AllAmount").text(b.toFixed(2))},_updateSingle:function(a){var b=[];$(".js-ischange").each(function(a,c){var d=$(c).find("#productId").val(),e=$(c).find("#bigImage").val(),f=$(c).find("#price").val(),g=$(c).find("#vid").val(),h=$(c).find("#vidSon").val(),i=$(c).find("#vidSon").parent().parent().find("#buyNum").val(),j={productId:d,bigImage:e,price:parseFloat(f),vid:g,vidSon:h,buyNum:parseInt(i)};b.push(j)}),dialogMask(function(a){$.ajax({type:"POST",url:G_PATH+"/dealer/shoper/updates",data:JSON.stringify(b),contentType:"application/json",dataType:"json",success:function(b){$(".js-clearing").data({issubmit:!0}),$(".js-ischange").removeClass("js-ischange"),a.hide()}})})},initQuickOrder:function(){function a(a){$.post(G_PATH+"/dealer/shopper/quick",{keyWord:a},function(b){if(126e3==b.code){var c=b.rows;if(c.length>0&&a.length>0){var d=$(".search-result").html("<ul></ul>").show().hover(null,function(){$(this).hide()});for(var e in c)var f=c[e].id,g=c[e].text.replace(new RegExp(a,"gi"),"<b>"+a+"</b> "),h=c[e].isAdd,i=$("<li>").appendTo($(d).find("ul")),j=$("<div>").appendTo(i),k=$(h?'<a href="javascript:void(0)" class="disable">已加入进货单</a>':"<a href=\"javascript:quickFormSubmit('"+f+"')\">加入进货单</a>").appendTo(j),l=$("<span>").html(g).appendTo(j);$(d).find("div").hover(function(){$(this).toggleClass("on")})}else $(".search-result").hide()}},"json")}var b=0;$("#key").keyup(function(){clearTimeout(b);var c=$(this).val();c.length>0&&(b=setTimeout(function(){a(c)},618))}).focus(function(){$(this).trigger("keyup")})},initClearCart:function(){$("#clearCart").click(function(){confirmDialog({title:"提示",content:"确定清空吗"},function(){$.post(G_PATH+"/dealer/shoper/deleteAll",{ids:null},function(a){null!=a&&(111e3==a.code?(remind("success","成功清除"),window.location.reload()):remind("error",a.message))},"json")})})},initTable:function(){$(".goods-attribute tr.goods-color:odd").css({"background-color":"#f9f9f9"}),$(".goods thead th").css({"background-color":"#f5f5f5"})},initAccordion:function(){function a(a){var b=$(".unfold").not($(a));$(b).each(function(a,b){var c=$(b).next().find("tr"),d=$(b).next().find("tr").not(".js-notnull").hide();1==c.length?($(b).hide(),$(c).show()):0==d.length?$(b).hide():$(b).html('<a href="javascript:;">未选'+$(b).next().find("tr").not(".js-notnull").length+'条 <i class="iconfont">&#xe60d;</i></a>').show()})}var b="<div class='unfold c-h'></div>";$(".goods-attribute .attributes").prepend(b),a($(".unfold").first()),$(document).on("click",".unfold",function(){$(this).hide().next().find("tr").show(),a(this)})}},quickFormSubmit=function(a){$("#addlist-form-quick").append($('<input type="hidden">').attr("name","products").val(a)).submit()};myShopper_index.init();