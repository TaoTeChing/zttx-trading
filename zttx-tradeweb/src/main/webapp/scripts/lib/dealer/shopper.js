define(function(require,exports,module){function a(a){for(var b in g)b===a.shopid&&g[a.shopid].push(a);g[a.shopid]||(g[a.shopid]=[],g[a.shopid].push(a))}function b(a){for(var b=g[a.shopid].length,c=0;b>c;c++){if(a.skuid&&g[a.shopid][c].skuid==a.skuid)return void 0!==a.num&&(g[a.shopid][c].num=a.num),void 0!==a.price&&(g[a.shopid][c].price=a.price),void 0!==a.type&&(g[a.shopid][c].type=a.type),void 0!==a.zk&&(g[a.shopid][c].zk=a.zk),!1;a.skuid||(g[a.shopid][c].type=a.type)}}function c(){$(".num-amount").each(function(){var b=$(this).data("shopid"),c=$(this).data("shopsid"),d=$(this).data("skuid"),e=$(this).val(),f=$(this).data("price"),g=$(this).data("type"),h=$(this).data("z");a({shopid:b,shopsid:c,skuid:d,num:e,price:f,type:g,zk:h})})}function d(a){if(a){for(var b,c=g[a].length,d=0,e=0,f=0;c>f;f++){var h=g[a][f].num*g[a][f].price;d+=Number(g[a][f].num),e+=h,b=Number(g[a][f].zk),$("#single_"+g[a][f].skuid).text(h.toFixed(2))}$("#number_"+a).text(d),$("#price_"+a).text(e.toFixed(2)),""!=b&&$("#zkj_"+a).text((e*(1-b)).toFixed(2))}else for(var i in g){for(var b,c=g[i].length,d=0,e=0,f=0;c>f;f++){var h=g[i][f].num*g[i][f].price;d+=Number(g[i][f].num),e+=h,b=Number(g[i][f].zk),$("#single_"+g[i][f].skuid).text(h.toFixed(2))}$("#number_"+i).text(d),$("#price_"+i).text(e.toFixed(2)),""!=b&&$("#zkj_"+i).text((e*(1-b)).toFixed(2))}}var e=require("underscore"),f=require("template");f.helper("$formatPrice",function(a){return null==a?0:a.toFixed(2)});var g=($(".simple-function"),$(".attr-item"),{});setTimeout(function(){c(),d()},1e3);var h={init:function(){this.initUI(),this.initCheckbox(),this.initNumber(),this.initSubmit(),this.initOpction(),this.toggleMore()},initUI:function(){var a=$(".product-disable");$(a).find("input").each(function(a,b){b.disabled=!0}),$(a).find("button").each(function(a,b){b.disabled=!0})},initCheckbox:function(){var a=this;$(".js-check-all").click(function(){$(".js-check-sub:not(:disabled),.js-check:not(:disabled),.js-check-all:not(:disabled)").prop("checked",this.checked),a._settlement()}),$(".js-check-sub").click(function(){$(this).parents(".order-item").find(".js-check:not(:disabled)").prop("checked",this.checked),a._settlement()}),$(".js-check").click(function(){a._settlement()})},initNumber:function(){function a(a,b,c){var d=0;return""==b?(remind("error","购买量太大"),d):$.isNumeric(a)?(0>a?d=0:a>b?(remind("error","购买量太大"),d=b):d=a,0==d?c.removeClass("js-notnull"):c.addClass("js-notnull"),c.addClass("js-ischange"),d):d}var c=this,f=e(function(a,e,f){b({shopid:a,skuid:e,num:f}),d(a),c._settlement(),c._updateSingle()}).debounce(300);$(document).on("click",".num-minus",function(){var b=$(this).next(),c=$(this).parents("tr"),d=b.data("shopid"),e=b.data("skuid"),g=b.val(),h=b.data("max");g--,g=a(g,h,c),b.val(g),f(d,e,g)}),$(document).on("click",".num-plus",function(){var b=$(this).prev(),c=$(this).parents("tr"),d=b.data("shopid"),e=b.data("skuid"),g=b.val(),h=b.data("max");g++,g=a(g,h,c),b.val(g),f(d,e,g)}),$(document).on("keyup",".num-amount",function(){var b=$(this),c=$(this).parents("tr"),d=b.data("shopid"),e=b.data("skuid"),g=b.val().replace(/[^\d]/g,""),h=b.data("max");b.val(g),g=a(g,h,c),b.val(g),f(d,e,g)})},_settlement:function(){var a=0,b=0,c=0,d=0;$(".js-check:checked").each(function(e,f){var g=$(f).parents(".m-con:not(.product-disable)");if("0"==$(g).find(".operate a.selected").data("type")){var h=Number($(g).find(".js-zkj").text())?Number($(g).find(".js-zkj").text()):0;d+=Number($(g).find(".js-price").text())-h,b+=Number($(g).find(".js-price").text()-h)}"2"==$(g).find(".operate a.selected").data("type")&&(d+=Number($(g).find(".js-price").text()),b+=Number($(g).find(".js-price").text())),"1"==$(g).find(".operate a.selected").data("type")&&(c+=Number($(g).find(".js-price").text())-Number($(g).find(".js-zkj").text()),b+=Number(Number($(g).find(".js-price").text())-Number($(g).find(".js-zkj").text()))),a+=Number($(g).find(".js-number").text())}),$(".js-allNumber").text(a),$(".js-allPrice").text(b.toFixed(2)),$(".js-nowproductprice").text(d.toFixed(2)),$(".js-dispribute").text(c.toFixed(2))},_updateSingle:function(a){var b=[];$(".js-ischange .num-amount").each(function(a,c){var d=$(c).data("shopsid"),e=$(c).data("shopid"),f=$(c).data("discount"),g=$(c).data("price"),h=$(c).data("skuid"),i=$(c).val(),j={refrenceId:d,shopId:e,purchaseNum:parseInt(i),discount:f,productSkuPrice:g,productSkuId:h};b.push(j)}),b.length>0&&dialogMask(function(a){$.ajax({type:"POST",url:"/dealer/dealerShopers/batchUpdate",data:JSON.stringify(b),contentType:"application/json",dataType:"json",success:function(b){$(".js-clearing")[0].disabled=!1,$(".js-ischange").removeClass("js-ischange"),a.hide()}})})},initOrder:function(){},initSubmit:function(){$(".js-clearing").click(function(){h.handelProductPrice(function(){var a=$(".js-check:checked:not(:disabled)"),b="";if($(a).length<1)return remind("error","至少勾选一个产品"),!1;var c=!0;$(a).each(function(a,d){var e=0,f=$(d).parents(".m-con"),g=$(f).find(".js-min-number").css({color:"#333"}),h=$(f).find(".num-amount").css({background:"#fff"}),i=$(f).find(".js-nayang.selected").length;$(h).each(function(a,b){e+=Number(b.value)}),0>=i&&Number($(g).text())>e&&($(g).css({color:"#e00"}),$(h).css({background:"#FFFFCC"}),""==b&&(b="商品没有达到起批量的要求"),c=!1),i>0&&e>1&&($(g).css({color:"#e00"}),$(h).css({background:"#FFFFCC"}),""==b&&(b="拿样产品只能选一件"),c=!1)}),""!=b&&remind("error",b);var d=[];$(a).each(function(){d.push($(this).data("shopper-id"))}),c&&d.length>0&&$("#submit-form-balance").append($('<input type="hidden" name="shopperIds">').val(d.join(","))).submit()})})},initOpction:function(){window.quickFormSubmit=function(a,b){$("#addlist-form-quick").append($('<input type="hidden">').attr("name","productsId").val(a)),$("#addlist-form-quick").append($('<input type="hidden">').attr("name","productsType").val(b)).submit()},$(".js-product-remove-all").click(function(){confirmDialog({title:"提示",content:"确定清空吗"},function(){$.post("/dealer/dealerShoper/removeCart",{dealerShopersId:null},function(a){null!=a&&(126e3==a.code?(remind("success","成功清除"),window.location.reload()):remind("error",a.message))},"json")})}),$(".js-product-remove-multi").click(function(){var a=[];return $(".js-check:checked").each(function(b,c){a.push($(c).data("shopper-id"))}),a.length<1?(remind("error","请选择需移除的产品"),!1):void confirmDialog({title:"提示",content:"确定移除吗"},function(){$.post("/dealer/dealerShoper/removeCart",{dealerShopersId:a.join(",")},function(a){null!=a&&(111e3==a.code||126e3==a.code?(remind("success","成功移除"),window.location.reload()):remind("error",a.message))},"json")})}),$(".js-product-remove-single").click(function(){var a=$(this).data("shoper-id");confirmDialog({title:"提示",content:"确定移除吗"},function(){$.post("/dealer/dealerShoper/removeCart",{dealerShopersId:a},function(a){null!=a&&(126e3==a.code?(remind("success","移除成功"),window.location.reload()):remind("error",a.message))},"json")})}),$(".js-product-remove-off").click(function(){var a=[];return $(".product-disable").each(function(){var b=$(this).find(".js-check").data("shopper-id");a.push(b)}),a.length<=0?(remind("error","暂无失效产品"),!1):void confirmDialog({title:"提示",content:"确定移除吗"},function(){$.post("/dealer/dealerShoper/removeCart",{dealerShopersId:a.join(",")},function(a){null!=a&&(126e3==a.code?(remind("success","移除成功"),window.location.reload()):remind("error",a.message))},"json")})}),$(".js-product-add-fav").click(function(){var a=$(this).data("productid");$.post(G_PATH+"/dealer/dealerFavorite/addFavorite",{productId:a},function(a){a=$.parseJSON(a),null!=a&&(126e3==a.code?remind("success","产品收藏成功"):remind("error",a.message))})})},toggleMore:function(){$(document).on("click",".simple-function",function(){var b=$(this),c=b.data("toggle"),d=b.parent();if(0==c){var e=b.data("isajax");if(0==e){var g=b.data("shopid"),h=b.data("productid"),i=b.data("producttype"),j=b.data("discount");$.ajax({url:"/dealer/dealerShoper/showMore",type:"post",data:{shoperId:g,productId:h,productType:i},dataType:"json",success:function(c){for(var e=0;e<c.rows.length;e++)c.rows[e].discount=j,a({shopid:c.rows[e].shoperId,shopsid:"",skuid:c.rows[e].productSkuId,num:"0",price:c.rows[e].productSkuPrice,type:c.rows[e].productType,zk:j});b.remove();var g=f.render("list_tempalte",c);d.find("tbody").append(g);var h=d.find("tbody tr").length;d.find("tbody tr").eq(0).find(".p-xiaoji").attr("rowspan",h)}})}}})},handelProductPrice:function(a){var b=[];return $(".js-check:checked").length<=0?(remind("error","至少勾选一个产品"),!1):($(".js-check:checked").each(function(a,c){for(var d=$(this).data("shopper-id"),e=($(this).parents(".m-con"),g[d]),f=0;f<e.length;f++)if(0!=e[f].num){var h={skuId:e[f].skuid,productType:e[f].type,productSkuPrice:e[f].price,quantity:e[f].num};b.push(h)}}),void dialogLoading(function(c){$.ajax({url:"/dealer/dealerShoper/synShopers?csrfToken="+$("input[name=csrfToken]").val(),method:"POST",data:JSON.stringify(b),contentType:"application/json",dataType:"json",success:function(b){if(126e3==b.code){var d=b.rows.length;if(d>0){for(var e=0;d>e;e++)$("#che_price_"+b.rows[e].skuId).css("color","red").html(b.rows[e].productSkuPrice),$("#che_stock_"+b.rows[e].skuId).css("color","red").html(b.rows[e].quantity),parseFloat($("#che_amount_"+b.rows[e].skuId).val())>b.rows[e].quantity&&$("#che_amount_"+b.rows[e].skuId).val(parseFloat(b.rows[e].quantity).toFixed(2));confirmDialog("请注意，您所选择的产品其中 "+d+" 款库存或价格有修改，是否继续提交？",function(){a&&a()})}else a&&a()}else remind("error",b.message);c.hide()},error:function(){remind("error","请求出错")}})},"正在同步产品信息，请稍后..."))},editAnddel:function(){var a=this;$(".js-del-single").click(function(){var c=$(this).parents("tr");if(!c.hasClass("already-delete")){var e=c.find(".num-amount"),f=e.data("shopid"),g=e.data("skuid");c.addClass("already-delete js-ischange"),c.find(".num-amount").val("0"),b({shopid:f,skuid:g,num:0}),d(f),a._updateSingle()}}),$(".edit-btn").click(function(){var a=$(this).parents(".attr-item");$(this).next().is(":visible")?($(this).removeClass("active").next().hide(),a.find(".js-count-1").show(),a.find(".js-count-2").hide(),a.find("tr.already-delete").removeClass("already-delete")):a.find("tr:visible").length>0&&($(this).addClass("active").next().css("height",a.height()+20).show(),a.find(".js-count-1").hide(),a.find(".js-count-2").show())})}},i={init:function(){this.initQuickOrder()},initTabs:function(){var a=$(".other .tab-head a"),b=$(".other .tab-item");$(a).click(function(){$(a).removeClass("active");var c=$(this).addClass("active").index();$(b).hide().eq(c).show()})},initCarousel:function(){seajs.use(["carousel","$"],function(a,$){new a({element:"#Carousel1",hasTriggers:!1,easing:"easeOutStrong",effect:"scrollx",panels:"#Carousel1 .ui-switchable-panel",step:1,viewSize:[192],circular:!0,autoplay:!1}).render(),new a({element:"#Carousel2",hasTriggers:!1,easing:"easeOutStrong",effect:"scrollx",step:1,viewSize:[192],circular:!0,autoplay:!1}).render()})},initQuickOrder:function(){function a(a){$.post("/dealer/dealerShoper/quickCart",{keyWord:a},function(b){if(126e3==b.code){var c=b.rows;if(c.length>0&&a.length>0){var d=$(".search-result").html("<ul></ul>").show().hover(null,function(){$(this).hide()});for(var e in c){var f=c[e].productId,g=c[e].productNo.replace(new RegExp(a,"gi"),"<b>"+a+"</b> "),h=c[e].isAdd,i=0;c[e].isCredit&&(type=1);var j=$("<li>").appendTo($(d).find("ul")),k=$("<div>").appendTo(j);$(h?'<a href="javascript:void(0)" class="disable">已加入进货单</a>':"<a href=\"javascript:quickFormSubmit('"+f+"','"+i+"')\">加入进货单</a>").appendTo(k),$("<span>").html(g).appendTo(k)}$(d).find("div").hover(function(){$(this).toggleClass("on")})}else $(".search-result").hide()}},"json")}var b=0;$("#key").keyup(function(){clearTimeout(b);var c=$(this).val();c.length>0&&(b=setTimeout(function(){a(c)},618))}).focus(function(){$(this).trigger("keyup")})}};return seajs.use(["template"],function(a){$(".operate a").click(function(){if($(this).hasClass("selected"))return!1;var a=$(this),c=$(this).data("type"),e=$(this).data("id"),f=$(this).parents(".m-con"),g=f.find(".attr-item");return b({shopid:e,type:c}),$.ajax({url:"/dealer/dealerShoper/updateTradeModel",method:"post",data:{productType:c,shoperId:e},dataType:"json",success:function(i){if(i&&i.object&&i.object.dealerShopersList.length>0){for(var j=0,k=i.object.dealerShopersList.length;k>j;j++)$("#che_price_"+i.object.dealerShopersList[j].productSkuId).text(i.object.dealerShopersList[j].productSkuPrice.toFixed(2)),b({shopid:i.object.dealerShopersList[j].shoperId,skuid:i.object.dealerShopersList[j].productSkuId,price:i.object.dealerShopersList[j].productSkuPrice}),d(i.object.dealerShopersList[j].shoperId),h._settlement(),a.parent().find("a").removeClass("selected"),a.addClass("selected");if(2==c&&(2==f.find(".count span").length&&f.find(".count span").eq(1).remove(),f.hasClass("product-disable")||(g.find("tr .num-amount").val(0),g.find("tr").addClass("js-ischange"),g.find("tr").eq(0).find(".num-amount").val(1),h._updateSingle(),g.find("tr .num-amount").each(function(){var a=$(this).data("shopid"),c=$(this).data("skuid"),d=$(this).val();b({shopid:a,skuid:c,num:d})}),d(g.find("tr .num-amount").data("shopid")),h._settlement())),1==c||0==c){var l=parseFloat(a.data("z"));if(void 0!=a.data("z")){var m=parseFloat(f.find(".js-price").text()),n=(m*(1-l)).toFixed(2);if(1==f.find(".count span").length){var o='<span>折扣优惠:<em class="js-zkj" id="zkj_'+e+'">'+n+"</em></span>";f.find(".count").append(o)}else f.find(".js-zkj").text(n)}}}}}),!1})}),i.init(),h.init(),{myOrder:h}});